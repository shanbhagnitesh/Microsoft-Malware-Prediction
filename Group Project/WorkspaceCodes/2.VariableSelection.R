install.packages("pROC")
install.packages("dplyr")
install.packages("readxl")

library(ISLR)
library(MASS)
library(pROC)
library(readr)

library(dplyr)
library(lubridate)
library(caret)
library(readxl)

setwd("C:/Users/nshanbhag/Desktop/BigDataAnalytics/Machine learning for Marketing/Group Project")


train <- read_csv("final_train.csv")
test<- read_csv("final_test.csv")

colnames(test)

train$X1 <- NULL
test$X1 <- NULL


calculate_lift <- function(predicted, reference, val){
  
  if (is.factor(reference)) 
    reference <- as.integer(as.character(reference))
  
  lift_val <- data.frame(predicted, reference)
  lift_val <- lift_val[order(-lift_val[, 1]), ]
  lift_val <- lift_val[1:floor(nrow(lift_val)*val/100),]
  lift_val$predicted <- ifelse(lift_val$predicted > 0.5,1,0)
  lift_val$result <- ifelse(lift_val$predicted == lift_val$reference & lift_val$predicted == 1, 1,0)
  
  res <- as.numeric(mean(lift_val$result)/mean(reference))
  return(res)
}


auc = function(trueval, predval){
  df = as.data.frame(cbind(trueval,predval))
  names(df) = c("trueval","predval")
  auc = roc(trueval~predval,data=df)$auc
  return(auc)
}


######################## Forward Selection Method 
#logistic regression model
lrm <- glm(HasDetections ~ ., data=train[, 2:52], family = binomial)

#forward stepwise selection
step.model <- stepAIC(lrm, direction = "forward", 
                      trace = FALSE)
summary(step.model)


######################## Backward Selection Method 
#logistic regression model
lrm <- glm(HasDetections ~ ., data=train[, 2:52], family = binomial)

#backward stepwise selection
step.model <- stepAIC(lrm, direction = "backward", 
                      trace = FALSE)
summary(step.model)


######################## Hybrid Selection Method 
#logistic regression model
lrm <- glm(HasDetections ~ ., data=train[, 2:52], family = binomial)

#hybrid stepwise selection
step.model <- stepAIC(lrm, direction = "both", 
                      trace = FALSE)
summary(step.model)






# STEPWISE Procedure

# All possible variables:
variables = names(train)[-2]
variables = variables[-1]
variablesorder = c()


# Construct a logistic regression model with no variables
model = glm(HasDetections ~ 1,data=train,family=binomial)

# Construct a formula with all the variables
formula<-formula(paste("HasDetections","~",paste(variables,collapse="+")))

# Stepwise procedure
for(i in c(1:length(variables))){
  #calculate AIC of each model
  info = add1(model,scope=formula,data=train)
  print(info)
  #get variable with lowest AIC
  orderedvariables = rownames(info[order(info$AIC),])
  v = orderedvariables[orderedvariables!="<none>"][1]
  #add variable to formula
  variablesorder = append(variablesorder,v)
  formulanew = formula(paste("HasDetections","~",paste(variablesorder,collapse = "+")))
  model = glm(formulanew,data=train,family=binomial)
  print(v)
}

auctrain = rep(0,length(variablesorder))
auctest = rep(0,length(variablesorder))
for(i in c(1:(length(variablesorder)))){
  vars = variablesorder[1:i]
  print(vars)
  formula<-paste("HasDetections","~",paste(vars,collapse="+"))
  model<-glm(formula,data=train,family="binomial")	
  predicttrain<-predict(model,newdata=train,type="response")
  predicttest<-predict(model,newdata=test,type="response")
  auctrain[i] = auc(train$HasDetections,predicttrain)
  auctest[i] = auc(test$HasDetections,predicttest)
} 

#SOLUTION
plot(auctrain, main="AUC", col="red", ylim=c(0.55,0.75))
par(new=TRUE)
plot(auctest,col="blue",add=TRUE, ylim=c(0.55,0.75))

train$Census_OSInstallLanguageIdentifierWOE <- NULL
test$Census_OSInstallLanguageIdentifierWOE 
test$Census_OSUILocaleIdentifierWOE_1 <- NULL

finalvariables = variablesorder[c(0:42)]


formula<-paste("HasDetections","~",paste(finalvariables,collapse="+"))
model<-glm(formula,data=train,family="binomial")	
predicttrain<-predict(model,newdata=train,type="response")
predicttest<-predict(model,newdata=test,type="response")
auctrain = auc(train$HasDetections,predicttrain)
auctest = auc(test$HasDetections,predicttest)
auctrain
auctest

# Auc train 69.79
# Auc train 74.22


predicted <- as.numeric(predicttrain>0.5)
reference <- train$HasDetections
u <- union(predicted, reference)
xtab <- table(factor(predicted, u), factor(reference, u))
confusionMatrix(xtab)

Top10Lift <- calculate_lift(predicttrain, reference, 10)
Top20Lift <- calculate_lift(predicttrain, reference, 20)
Top30Lift <- calculate_lift(predicttrain, reference, 30)
Top40Lift <- calculate_lift(predicttrain, reference, 40)
Top50Lift <- calculate_lift(predicttrain, reference, 50)
Top10Lift 
Top20Lift
Top30Lift
Top40Lift
Top50Lift



predicted <- as.numeric(predicttest>0.5)
reference <- test$HasDetections
u <- union(predicted, reference)
xtab <- table(factor(predicted, u), factor(reference, u))
confusionMatrix(xtab)

Top10Lift <- calculate_lift(predicttest, reference, 10)
Top20Lift <- calculate_lift(predicttest, reference, 20)
Top30Lift <- calculate_lift(predicttest, reference, 30)
Top40Lift <- calculate_lift(predicttest, reference, 40)
Top50Lift <- calculate_lift(predicttest, reference, 50)
Top10Lift 
Top20Lift
Top30Lift
Top40Lift
Top50Lift

colnames(test)

##### The Variables are selected and tried and it all give the same AUC

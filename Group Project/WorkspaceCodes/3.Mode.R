# Custom function to calculate AUC:
install.packages("ROCR")
install.packages("leaps")
install.packages("rpart")
install.packages("mlbench")
install.packages("caret")
install.packages("gplots")
install.packages("caret")

library(ROCR)
library(pROC)
library(rpart)
library(randomForest)
library(caret)
library(dplyr)
library(lubridate)
library(leaps)
library(rpart)
library(mlbench)
library(caret)
library(ROCR)
library(gplots)
library(caret)

train$Census_OSInstallLanguageIdentifierWOE <- NULL
test$Census_OSInstallLanguageIdentifierWOE 
test$Census_OSUILocaleIdentifierWOE_1 <- NULL

selected = c("EngineVersionWOE","AppVersionWOE","RtpStateBitfieldWOE","DefaultBrowsersIdentifierWOE","AVProductsInstalledWOE","CountryIdentifierWOE",
             "OrganizationIdentifierWOE","GeoNameIdentifierWOE","LocaleEnglishNameIdentifierWOE","PlatformWOE","ProcessorWOE","OsSuiteWOE","OsPlatformSubReleaseWOE",
             "OsBuildLabWOE","SmartScreenWOE","UacLuaenableWOE","Census_MDC2FormFactorWOE","Census_OEMNameIdentifierWOE","Census_PrimaryDiskTotalCapacityWOE",
             "Census_PrimaryDiskTypeNameWOE","Census_TotalPhysicalRAMWOE","Census_InternalPrimaryDiagonalDisplaySizeInInchesWOE","Census_InternalBatteryTypeWOE",
             "Census_OSBuildNumberWOE","Census_OSBuildRevisionWOE","Census_OSEditionWOE","Census_OSUILocaleIdentifierWOE","Wdft_RegionIdentifierWOE",
             "Wdft_IsGamerWOE","Census_IsSecureBootEnabledWOE","Census_FlightRingWOE","Census_OSWUAutoUpdateOptionsNameWOE","HasDetections")

train1 = train[,selected]

train2 = sample(1:length(train1), 80000, replace=T)
train1 = train1 %>% slice(train2)

test1 = test[,selected]

calculate_lift <- function(predicted, reference, val){
  
  if (is.factor(reference)) 
    reference <- as.integer(as.character(reference))
  
  lift_val <- data.frame(predicted, reference)
  lift_val <- lift_val[order(-lift_val[, 1]), ]
  lift_val <- lift_val[1:floor(nrow(lift_val)*val/100),]
  lift_val$predicted <- ifelse(lift_val$predicted > 0.5,1,0)
  lift_val$result <- ifelse(lift_val$predicted == lift_val$reference & lift_val$predicted == 1, 1,0)
  
  res <- as.numeric(mean(lift_val$result)/mean(reference))
  return(res)
}


auc = function(trueval, predval){
  df = as.data.frame(cbind(trueval,predval))
  names(df) = c("trueval","predval")
  auc = roc(trueval~predval,data=df)$auc
  return(auc)
}

#FILTER (PEARSON CORRELATION)
variables = names(train)[-2]
variables = variables[-1]
variablesorder = c()


selected = c()





length(vars)
for(v in variables){
  print(v)
  cortest = cor.test(as.vector(unlist(train[,c(v)])),as.vector(unlist(train[,c("HasDetections")])),method="pearson")
  pvalue = cortest$p.value
  print(pvalue)
  if(pvalue<0.001){
    selected = c(selected,v)
  }
}


f = paste("HasDetections~", paste(selected,collapse="+"))
colnames(train)
lrmodel = glm(as.formula(f),data=train[,], family="binomial")

predictions_train = predict(lrmodel,newdata=train,type="response")
predictions_test = predict(lrmodel,newdata=test,type="response")
auc(train$HasDetections,predictions_train)
auc(test$HasDetections,predictions_test)

selected = c(selected,"HasDetections")

# Auc train 0.6977
# Auc train 0.7448

predicted <- as.numeric(predictions_train>=0.5)
reference <- train$HasDetections
u <- union(predicted, reference)
xtab <- table(factor(predicted, u), factor(reference, u))
confusionMatrix(xtab)

Top10Lift <- calculate_lift(predictions_train, reference, 10)
Top20Lift <- calculate_lift(predictions_train, reference, 20)
Top30Lift <- calculate_lift(predictions_train, reference, 30)
Top40Lift <- calculate_lift(predictions_train, reference, 40)
Top50Lift <- calculate_lift(predictions_train, reference, 50)
Top10Lift 
Top20Lift
Top30Lift
Top40Lift
Top50Lift

predicted <- as.numeric(predictions_test>=0.5)
reference <- test$HasDetections
u <- union(predicted, reference)
xtab <- table(factor(predicted, u), factor(reference, u))
confusionMatrix(xtab)

Top10Lift <- calculate_lift(predictions_test, reference, 10)
Top20Lift <- calculate_lift(predictions_test, reference, 20)
Top30Lift <- calculate_lift(predictions_test, reference, 30)
Top40Lift <- calculate_lift(predictions_test, reference, 40)
Top50Lift <- calculate_lift(predictions_test, reference, 50)
Top10Lift 
Top20Lift
Top30Lift
Top40Lift
Top50Lift





# Decision tree

ctrl = rpart.control(minsplit = 10,cp = 0.0001, minbucket = 25,maxdepth = 10) 
tree <- rpart(HasDetections ~ .,data = train1, method="class", control = ctrl)

predictions_test <- as.data.frame(predict(object = tree, newdata = test1, type = "prob"))
predictions_train <- as.data.frame(predict(object = tree, newdata = train1, type = "prob"))

predictions_test <- as.numeric(predictions_test$`1`)
predictions_train <- as.numeric(predictions_train$`1`)


auc(train$HasDetections,predictions_train)
auc(test$HasDetections,predictions_test)

predicted <- as.numeric(predictions_train > 0.5)
reference <- train$HasDetections
u <- union(predicted, reference)
xtab <- table(factor(predicted, u), factor(reference, u))
confusionMatrix(xtab)


Top10Lift <- calculate_lift(predictions_train, reference, 10)
Top20Lift <- calculate_lift(predictions_train, reference, 20)
Top30Lift <- calculate_lift(predictions_train, reference, 30)
Top40Lift <- calculate_lift(predictions_train, reference, 40)
Top50Lift <- calculate_lift(predictions_train, reference, 50)
Top10Lift 
Top20Lift
Top30Lift
Top40Lift
Top50Lift



predicted <- as.numeric(predictions_test > 0.5)
reference <- test$HasDetections
u <- union(predicted, reference)
xtab <- table(factor(predicted, u), factor(reference, u))
confusionMatrix(xtab)



Top10Lift <- calculate_lift(predictions_test, reference, 10)
Top20Lift <- calculate_lift(predictions_test, reference, 20)
Top30Lift <- calculate_lift(predictions_test, reference, 30)
Top40Lift <- calculate_lift(predictions_test, reference, 40)
Top50Lift <- calculate_lift(predictions_test, reference, 50)
Top10Lift 
Top20Lift
Top30Lift
Top40Lift
Top50Lift



# AUC for both train and test is 75.24 and 71.96

# Random Forest



unique(train1$HasDetections)
train1$HasDetections <- as.factor(as.character(train1$HasDetections))
rForest <- randomForest(HasDetections ~ .,data = train1, ntree=25,na.action=na.exclude)
plot(rforest)
predictions_test <- as.data.frame(predict(object = rForest, newdata = test1, type = "prob"))
predictions_train <- as.data.frame(predict(object = rForest, newdata = train1, type = "prob"))

auc(train1$HasDetections,predictions_train$`1`)
auc(test1$HasDetections,predictions_test$`1`)

# Auc train 99.98
# Auc train 83.09


predicted <- as.numeric(predictions_train$`1` > 0.5)
reference <- train1$HasDetections
u <- union(predicted, reference)
xtab <- table(factor(predicted, u), factor(reference, u))
confusionMatrix(xtab)


Top10Lift <- calculate_lift(predictions_train$`1`, reference, 10)
Top20Lift <- calculate_lift(predictions_train$`1`, reference, 20)
Top30Lift <- calculate_lift(predictions_train$`1`, reference, 30)
Top40Lift <- calculate_lift(predictions_train$`1`, reference, 40)
Top50Lift <- calculate_lift(predictions_train$`1`, reference, 50)

Top10Lift 
Top20Lift
Top30Lift
Top40Lift
Top50Lift



predicted <- as.numeric(predictions_test$`1` >0.5)
reference <- test1$HasDetections
u <- union(predicted, reference)
xtab <- table(factor(predicted, u), factor(reference, u))
confusionMatrix(xtab)
# Better AUC but again We are unable to predict any donors

table(test$HasDetections)
#   0      1 
# 25493   152

Top10Lift <- calculate_lift(predictions_test$`1`, reference, 10)
Top20Lift <- calculate_lift(predictions_test$`1`, reference, 20)
Top30Lift <- calculate_lift(predictions_test$`1`, reference, 30)
Top40Lift <- calculate_lift(predictions_test$`1`, reference, 40)
Top50Lift <- calculate_lift(predictions_test$`1`, reference, 50)
Top10Lift 
Top20Lift
Top30Lift
Top40Lift
Top50Lift


##############################################################################
# Trying out SVM 



### SVM

# Run svm linear model

set.seed(2)

svm.linear = svm(HasDetections ~ ., data=train1, kernel="linear", cost=10)





predictions_test <- predict(object = svm.linear, newdata = test1, type = "response")

predictions_train <- predict(object = svm.linear, newdata = train1, type = "response")



predictions_test <- as.numeric(predictions_test)

predictions_train <- as.numeric(predictions_train)



auc(train1$HasDetections,predictions_train)

auc(test1$HasDetections,predictions_test)





# Run svm kernel model

set.seed(2)

svm.kernel = svm(HasDetections ~ ., data=train1, kernel="kernel", cost=10)





predictions_test <- predict(object = svm.kernel, newdata = test1, type = "response")

predictions_train <- predict(object = svm.kernel, newdata = train1, type = "response")



predictions_test <- as.numeric(predictions_test)

predictions_train <- as.numeric(predictions_train)



auc(train1$HasDetections,predictions_train)

auc(test1$HasDetections,predictions_test)





# Run svm polynomial kernel model

set.seed(2)

svm.poly = svm(HasDetections ~ ., data=train1, kernel="poly", cost=10)





predictions_test <- predict(object = svm.poly, newdata = test1, type = "response")

predictions_train <- predict(object = svm.poly, newdata = train1, type = "response")



predictions_test <- as.numeric(predictions_test)

predictions_train <- as.numeric(predictions_train)



auc(train1$HasDetections,predictions_train)

auc(test1$HasDetections,predictions_test)
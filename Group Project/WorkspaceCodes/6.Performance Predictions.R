##############################
#      6 - Benchmarking      #
##############################

# Load-in the libraries required

library(pROC)
library(pbapply)
library(data.table)
library(dplyr)
library(ROCR)

# calculate_performance_params - Function to calculate Accuracy, Sensitivity, Specficity,
# Top10Lift, Top20Lift, Top30Lift, Top40Lift, Top50Lift
calculate_performance_params <- function(under_obs, test1_p){
  
  predicted <- as.numeric(test1_p[,under_obs]>0.5)
  reference <- test1_p[,"HasDetections"]
  u <- union(predicted, reference)
  xtab <- table(factor(predicted, u), factor(reference, u))
  acc <- confusionMatrix(xtab)$overall[[1]]
  Sensitivity <- confusionMatrix(xtab)$byClass[[1]]
  Specificity <- confusionMatrix(xtab)$byClass[[2]]
  
  predicted <- test1_p[,under_obs]
  
  Top10Lift <- calculate_lift(predicted, reference, 10)
  Top20Lift <- calculate_lift(predicted, reference, 20)
  Top30Lift <- calculate_lift(predicted, reference, 30)
  Top40Lift <- calculate_lift(predicted, reference, 40)
  Top50Lift <- calculate_lift(predicted, reference, 50)
  
  auc_val <- auc(test1_p[,"HasDetections"],test1_p[,under_obs])
  
  df <- data.frame("auc" = auc_val, "acc" = acc, 
                   "Sensitivity" = Sensitivity, "Specificity"= Specificity, 
                   "Top10Lift" = Top10Lift, "Top20Lift" = Top20Lift,
                   "Top30Lift" = Top30Lift, "Top40Lift" = Top40Lift,
                   "Top50Lift" = Top50Lift)
  
  return(df)
}

# calculate_lift- For calculating Lift
calculate_lift <- function(predicted, reference, val){
  
  if (is.factor(reference)) 
    reference <- as.integer(as.character(reference))
  
  lift_val <- data.frame(predicted, reference)
  lift_val <- lift_val[order(-lift_val[, 1]), ]
  lift_val <- lift_val[1:floor(nrow(lift_val)*val/100),]
  lift_val$predicted <- ifelse(lift_val$predicted > 0.5,1,0)
  lift_val$result <- ifelse(lift_val$predicted == lift_val$reference & lift_val$predicted == 1, 1,0)
  
  res <- as.numeric(mean(lift_val$result)/mean(reference))
  return(res)
}

# Custom function to calculate AUC:
auc = function(trueval, predval){
  df = as.data.frame(cbind(trueval,predval))
  names(df) = c("trueval","predval")
  auc = roc(trueval~predval,data=df)$auc
  return(auc)
}

# List all the Predictions files for both the algorithms
pred_files <- list.files("C:/Users/nshanbhag/Desktop/BigDataAnalytics/Machine learning for Marketing/Group Project/output_predicted/")
pred_files <- paste0("C:/Users/nshanbhag/Desktop/BigDataAnalytics/Machine learning for Marketing/Group Project/output_predicted/", pred_files)

pred_files_mixed <- list.files("C:/Users/nshanbhag/Desktop/BigDataAnalytics/Machine learning for Marketing/Group Project/output_predicted - Mixed/")
pred_files_mixed <- paste0("C:/Users/nshanbhag/Desktop/BigDataAnalytics/Machine learning for Marketing/Group Project/output_predicted - Mixed/", pred_files_mixed)

# Take only train1ing files
pred_files_train1 <- pred_files[grepl(".train1.",pred_files)]
pred_files_mixed_train1 <- pred_files_mixed[grepl(".train1.",pred_files_mixed)]

# Take only test1ing files
pred_files <- pred_files[grepl(".test1.",pred_files)]
pred_files_mixed <- pred_files_mixed[grepl(".test1.",pred_files_mixed)]

# input_data - For reading data
input_data <- function(path){
  df <- read.csv(path, stringsAsFactors = F)
  df <- df[colnames(df) %in% c("HasDetections","p_1")]
  df$index <- 1:nrow(df)
  if(grepl("*under0.4_p.csv",path)){
    df$under_rate <- 0.4
  }
  if(grepl("*under0.5_p.csv",path)){
    df$under_rate <- 0.5
  }
  return(df)
  
}

# Read all the Predictions from both the algorithms - test1
myfiles <- pblapply(pred_files, input_data)
myfilesmixed <- pblapply(pred_files_mixed, input_data)

# Read all the Predictions from both the algorithms - train1
myfiles_train1 <- pblapply(pred_files_train1, input_data)
myfilesmixed_train1 <- pblapply(pred_files_mixed_train1, input_data)

# Create Data Frame
pred_data <- bind_rows(myfiles)
pred_data_mixed <- bind_rows(myfilesmixed)

pred_data_train1 <- bind_rows(myfiles_train1)
pred_data_mixed_train1 <- bind_rows(myfilesmixed_train1)

# Take a vote of all the 5*2 by averaging-out the predicted probabilities
pred_data <- pred_data %>%
  group_by(under_rate, index) %>%
  summarise(HasDetections = mean(HasDetections),
            p_1 = mean(p_1))

pred_data_mixed <- pred_data_mixed %>%
  group_by(index) %>%
  summarise(HasDetections = mean(HasDetections),
            p_1 = mean(p_1))

pred_data_train1 <- pred_data_train1 %>%
  group_by(under_rate, index) %>%
  summarise(HasDetections = mean(HasDetections),
            p_1 = mean(p_1))

pred_data_mixed_train1 <- pred_data_mixed_train1 %>%
  group_by(index) %>%
  summarise(HasDetections = mean(HasDetections),
            p_1 = mean(p_1))

pred_data_0.4 <- subset(pred_data, under_rate == 0.4)
pred_data_0.5 <- subset(pred_data, under_rate == 0.5)

pred_data_0.4_train1 <- subset(pred_data_train1, under_rate == 0.4)
pred_data_0.5_train1 <- subset(pred_data_train1, under_rate == 0.5)

# Create a final Data frame with all the predictions
final_predictions_test1 <- data.frame("HasDetections" = test1$HasDetections,
                                     "Undersampling_0.4" = pred_data_0.4$p_1,
                                     "Undersampling_0.5" = pred_data_0.5$p_1,
                                     "Mixed_Sampling" = pred_data_mixed$p_1)

final_predictions_train1 <- data.frame("HasDetections" = train1$HasDetections,
                                      "Undersampling_0.4" = pred_data_0.4_train1$p_1,
                                      "Undersampling_0.5" = pred_data_0.5_train1$p_1,
                                      "Mixed_Sampling" = pred_data_mixed_train1$p_1)
write.csv(final_predictions_test1, file="C:/Users/nshanbhag/Desktop/BigDataAnalytics/Machine learning for Marketing/Group Project/final_predictions_test1.csv", row.names=F)
write.csv(final_predictions_train1, file="C:/Users/nshanbhag/Desktop/BigDataAnalytics/Machine learning for Marketing/Group Project/final_predictions_train1.csv", row.names=F)

# Calculating performance parameters - test1
df_0.4_test1 <- calculate_performance_params("Undersampling_0.4",final_predictions_test1)
df_0.5_test1 <- calculate_performance_params("Undersampling_0.5",final_predictions_test1)

df_mixed_test1<- calculate_performance_params("Mixed_Sampling",final_predictions_test1)

df_0.4_test1$under_rate <- 0.4
df_0.5_test1$under_rate <- 0.5
df_mixed_test1$under_rate <- NA

# Calculating performance parameters - train1
df_0.4_train1 <- calculate_performance_params("Undersampling_0.4",final_predictions_train1)
df_0.5_train1 <- calculate_performance_params("Undersampling_0.5",final_predictions_train1)

df_mixed_train1 <- calculate_performance_params("Mixed_Sampling",final_predictions_train1)

df_0.4_train1$under_rate <- 0.4
df_0.5_train1$under_rate <- 0.5
df_mixed_train1$under_rate <- NA

# Create a final Data frame with all the performance parameters
final_performance_test1 <- rbind(df_0.4_test1,df_0.5_test1,df_mixed_test1)
final_performance_test1$Data_Type <- "test1"
final_performance_train1 <- rbind(df_0.4_train1,df_0.5_train1,df_mixed_train1)
final_performance_train1$Data_Type <- "train1"
final_performance <- rbind(final_performance_test1,final_performance_train1)
write.csv(final_performance, file="C:/Users/nshanbhag/Desktop/BigDataAnalytics/Machine learning for Marketing/Group Project/final_performance1.csv", row.names=F)

# Create Gains and Lift Curve
pred_0.4 <- prediction(final_predictions_test1$Undersampling_0.4, final_predictions_test1$HasDetections)
pred_0.5 <- prediction(final_predictions_test1$Undersampling_0.5, final_predictions_test1$HasDetections)
pred_Mixed <- prediction(final_predictions_test1$Mixed_Sampling, final_predictions_test1$HasDetections)

gain_0.4 <- performance(pred_0.4, "tpr", "rpp")
gain_0.5 <- performance(pred_0.5, "tpr", "rpp")
gain_Mixed <- performance(pred_Mixed, "tpr", "rpp")

plot(gain_0.4, main = "Gain Chart", col="red")
plot(gain_0.5, add = T,main = "Gain Chart", col="blue")
plot(gain_Mixed, add = T,main = "Gain Chart", col="green")
abline(v=0.1)
abline(v=0.2)
abline(v=0.3)
abline(v=0.4)


lifty_0.4 <- performance(pred_0.4, "lift", "rpp")
lifty_0.5 <- performance(pred_0.5, "lift", "rpp")
lifty_Mixed <- performance(pred_Mixed, "lift", "rpp")

plot(lifty_0.4, main = "Lift Chart", col="red")
plot(lifty_0.5, add = T, main = "Lift Chart", col="blue")
plot(lifty_Mixed, add = T, main = "Lift Chart", col="green")
abline(v=0.1)
abline(v=0.2)
abline(v=0.3)
abline(v=0.4)

